{"version":3,"sources":["../../../src/datasources/fault-ds/datasource.js"],"names":["ClientDelegate","API","FilterCloner","_","OpenNMSFMDatasource","instanceSettings","$q","backendSrv","templateSrv","type","url","name","q","alarmClient","options","filter","targets","Filter","limit","clonedFilter","cloneFilter","substitute","clauses","self","findAlarms","then","alarms","data","toTable","each","clause","restriction","NestedRestriction","value","replace","scopedVars","datasourceRequest","method","response","status","message","title","when","query","find","getAttributes","getAttributeComparators","attribute","searchForValues","findOperators","findAttribute","findUsers","map","rows","user","id","label","findNodes","node","findCategories","category","findLocations","location","findSeverities","severity","findServices","service","columnNames","columns","column","row","alarm","logMessage","description","uei","nodeId","nodeLabel","ipAddress","serviceType","undefined","ackUser","firstEventTime","lastEventTime","lastEvent","source","troubleTicket","troubleTicketState","count","meta","alarmId","getAlarm","doAck","doUpdate","ack","clear","escalate","doTicketAction","sticky","saveSticky","deleteSticky","journal","saveJournal","deleteJournal"],"mappings":"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","file":"datasource.js","sourcesContent":["import {ClientDelegate} from './client_delegate';\nimport {API} from '../../opennms';\nimport {FilterCloner} from \"./FilterCloner\"\nimport _ from 'lodash';\n\nexport class OpenNMSFMDatasource {\n\n  constructor(instanceSettings, $q, backendSrv, templateSrv) {\n    this.type = instanceSettings.type;\n    this.url = instanceSettings.url;\n    this.name = instanceSettings.name;\n    this.q = $q;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n    this.alarmClient = new ClientDelegate(instanceSettings, backendSrv, $q);\n  }\n\n  query(options) {\n      // Initialize filter\n      var filter = options.targets[0].filter || new API.Filter();\n      filter.limit = 0; // no limit\n\n      // Clone Filter to prevent some issues and also make substitution possible\n      // (otherwise substitution would happen in original query, and overwriting the $<variable> which may not be the intention)\n      var clonedFilter = new FilterCloner().cloneFilter(filter);\n      this.substitute(clonedFilter.clauses, options);\n\n      var self = this;\n      return this.alarmClient.findAlarms(clonedFilter).then(function(alarms) {\n          return {\n              data: self.toTable(alarms)\n          };\n      });\n  }\n\n  substitute(clauses, options) {\n      const self = this;\n      _.each(clauses, clause => {\n        if (clause.restriction) {\n            if (clause.restriction instanceof API.NestedRestriction) {\n                self.substitute(clause.restriction.clauses, options);\n            } else if (clause.restriction.value) {\n                // TODO MVR: This is a hint on how to probably best implement HELM-12\n                // clause.restriction.value = clause.restriction.value.replace(/\\$timeFrom/g, options.range.from.valueOf());\n                // clause.restriction.value = clause.restriction.value.replace(/\\$timeTo/g, options.range.to.valueOf());\n                clause.restriction.value = self.templateSrv.replace(clause.restriction.value, options.scopedVars);\n            }\n        }\n      });\n  }\n\n  testDatasource() {\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/rest/info',\n      method: 'GET'\n    }).then(response => {\n      if (response.status === 200) {\n        return {status: \"success\", message: \"Data source is working\", title: \"Success\"};\n      }\n    });\n  }\n\n  annotationQuery(options) {\n    return this.q.when([]);\n  }\n\n  metricFindQuery(query) {\n    if (!query || !query.find) {\n        return this.q.when([]);\n    }\n\n    if (query.find === \"attributes\") {\n      return this.q.when(this.alarmClient.getAttributes());\n    }\n    if (query.find === \"comparators\") {\n      return this.q.when(this.alarmClient.getAttributeComparators(query.attribute));\n    }\n    if (query.find == 'values') {\n        return this.searchForValues(query);\n    }\n    if (query.find === 'operators') {\n        return this.alarmClient.findOperators();\n    }\n    return this.q.when([]);\n  }\n\n  searchForValues(query) {\n      let attribute = this.alarmClient.findAttribute(query.attribute) || {};\n      switch (attribute.type) {\n          case 'user':\n              return this.alarmClient.findUsers({query: query.query})\n                  .then(function(data) {\n                      return _.map(data.rows, function(user) {\n                          return {\n                              id: user['user-id'],\n                              label: user['full-name']\n                          };\n                      });\n                  });\n          case 'node':\n              return this.alarmClient.findNodes({query: query.query})\n                  .then(function(data) {\n                      return _.map(data.rows, function(node) {\n                        return {\n                            id: node.id,\n                            label: node.label\n                        }\n                      });\n                  });\n          case 'category':\n              return this.alarmClient.findCategories({query: query.query})\n                  .then(function(data) {\n                      return _.map(data.rows, function(category) {\n                          return {\n                              id: category.id,\n                              label: category.name\n                          };\n                      })\n                  });\n          case 'location':\n              return this.alarmClient.findLocations({query: query.query})\n                  .then(function(data) {\n                      return _.map(data.rows, function(location) {\n                          return {\n                              id: location['location-name'],\n                              label: location['location-name']\n                          };\n                      })\n                  });\n          case 'severity':\n              return this.alarmClient.findSeverities({query: query.query})\n                  .then(function(data) {\n                      return _.map(data, function(severity) {\n                          return {\n                              id: severity.id,\n                              label: severity.label\n                          }\n                      })\n                  });\n          case 'service':\n              return this.alarmClient.findServices({query: query.query})\n                  .then(function(data) {\n                      return _.map(data.rows, function(service) {\n                          return {\n                              id: service,\n                              label: service\n                          }\n                      })\n                  })\n      }\n      return this.q.when([]);\n  }\n\n    // Converts the data fetched from the Alarm REST Endpoint of OpenNMS to the grafana table model\n    toTable(alarms) {\n        var columnNames = [\n            \"Log Message\", \"Description\",\n            \"UEI\", \"Node ID\", \"Node Label\",\n            \"IP Address\", \"Service\", \"Acked By\", \"Severity\",\n            \"First Event Time\", \"Last Event Time\", \"Event Source\",\n            \"Trouble Ticket\", \"Trouble Ticket State\", \"Count\"];\n\n        var columns = _.map(columnNames, column => {\n            return { \"text\" : column }\n        });\n\n        var rows = _.map(alarms, alarm => {\n            var row = [\n                alarm.logMessage,\n                alarm.description,\n                alarm.uei,\n                alarm.nodeId,\n                alarm.nodeLabel,\n                alarm.ipAddress,\n                alarm.serviceType ? alarm.serviceType.name : undefined,\n                alarm.ackUser,\n                alarm.severity.label,\n                alarm.firstEventTime,\n                alarm.lastEventTime,\n                alarm.lastEvent.source,\n                alarm.troubleTicket,\n                alarm.troubleTicketState,\n                alarm.count\n            ];\n            row.meta = {\n                // Store the alarm for easy access by the panels - may not be necessary\n                'alarm': alarm,\n                // Store the name of the data-source as part of the data so that\n                // the panel can grab an instance of the DS to perform actions\n                // on the alarms\n                \"source\": this.name\n            };\n            return row;\n        });\n\n        return [\n            {\n                \"columns\": columns,\n                \"rows\": rows,\n                \"type\": \"table\",\n            }\n        ];\n    }\n\n    getAlarm(alarmId) {\n        return this.alarmClient.getAlarm(alarmId);\n    }\n\n    acknowledgeAlarm(alarmId) {\n      return this.alarmClient.doAck(alarmId);\n    }\n\n    unacknowledgeAlarm(alarmId) {\n        this.alarmClient.doUpdate(alarmId, {ack: false});\n    }\n\n    clearAlarm(alarmId) {\n        this.alarmClient.doUpdate(alarmId, {clear: true});\n    }\n\n    escalateAlarm(alarmId) {\n        this.alarmClient.doUpdate(alarmId, {escalate: true});\n    }\n\n    createTicketForAlarm(alarmId) {\n        this.alarmClient.doTicketAction(alarmId, \"create\");\n    }\n\n    updateTicketForAlarm(alarmId) {\n        this.alarmClient.doTicketAction(alarmId, \"update\");\n    }\n\n    closeTicketForAlarm(alarmId) {\n        this.alarmClient.doTicketAction(alarmId, \"close\");\n    }\n\n    saveSticky(alarmId, sticky) {\n      return this.alarmClient.saveSticky(alarmId, sticky);\n    }\n\n    deleteSticky(alarmId) {\n      return this.alarmClient.deleteSticky(alarmId);\n    }\n\n    saveJournal(alarmId, journal) {\n      return this.alarmClient.saveJournal(alarmId, journal);\n    }\n\n    deleteJournal(alarmId) {\n      return this.alarmClient.deleteJournal(alarmId);\n    }\n}\n"]}