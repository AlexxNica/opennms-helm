{"version":3,"sources":["../../../src/datasources/fault-ds/client_delegate.js"],"names":["API","Client","Rest","DAO","Model","_","ClientDelegate","settings","backendSrv","$q","type","url","name","searchLimit","server","OnmsServer","http","GrafanaHTTP","client","clientWithMetadata","undefined","self","getMetadata","then","metadata","apiVersion","Error","catch","e","getClientWithMetadata","alarms","filter","getAlarmDao","alarmDao","find","alarmId","get","user","escalate","clear","unacknowledge","acknowledge","action","supportedActions","indexOf","message","datasourceRequest","method","sticky","saveStickyMemo","deleteStickyMemo","journal","saveJournalMemo","deleteJournalMemo","options","params","limit","results","data","count","totalCount","node","query","location","category","severities","map","Severities","severity","id","label","when","element","operators","Operators","operator","searchProperties","propertyId","getProperties","properties","property","findProperty","comparators","getComparators","length","console","log","Comparators","EQ"],"mappings":"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","file":"client_delegate.js","sourcesContent":["import {API, Client, Rest, DAO, Model} from '../../opennms'\nimport _ from 'lodash';\n\nexport class ClientDelegate {\n\n    constructor(settings, backendSrv, $q) {\n        this.type = settings.type;\n        this.url = settings.url;\n        this.name = settings.name;\n        this.backendSrv = backendSrv;\n        this.searchLimit = 1000;\n        this.$q = $q;\n\n        let server = new API.OnmsServer(this.name, this.url);\n        let http = new Rest.GrafanaHTTP(this.backendSrv, server);\n        this.client = new Client(http);\n        this.client.server = server;\n        this.clientWithMetadata = undefined;\n     }\n\n    getClientWithMetadata() {\n        if (!this.clientWithMetadata) {\n              let self = this;\n              this.clientWithMetadata = Client.getMetadata(this.client.server, this.client.http)\n                .then(function(metadata) {\n                    // Ensure the OpenNMS we are talking to is compatible\n                    if (metadata.apiVersion() !== 2) {\n                        throw new Error(\"Unsupported Version\");\n                    }\n                    self.client.server.metadata = metadata;\n                    return self.client;\n                }).catch(function(e) {\n                    // in case of error, reset the client, otherwise\n                    // the datasource may never recover\n                    self.clientWithMetadata = void 0;\n                    throw e;\n                });\n        }\n        return this.clientWithMetadata;\n      }\n\n    getAlarmDao() {\n        return this.getClientWithMetadata().then(function(client) {\n            return client.alarms();\n        });\n    }\n\n    findAlarms(filter) {\n        return this.getAlarmDao()\n            .then(function(alarmDao) {\n                return alarmDao.find(filter);\n            });\n    }\n\n    getAlarm(alarmId) {\n      return this.getAlarmDao()\n        .then(function(alarmDao) {\n            return alarmDao.get(alarmId);\n        });\n    }\n\n    doEscalate(alarmId, user) {\n        return this.getAlarmDao()\n            .then(alarmDao => {\n                return alarmDao.escalate(alarmId, user)\n            });\n    }\n\n    doClear(alarmId, user) {\n        return this.getAlarmDao()\n            .then(alarmDao => {\n                return alarmDao.clear(alarmId, user);\n            });\n    }\n\n    doUnack(alarmId, user) {\n        return this.getAlarmDao()\n            .then(alarmDao => {\n                return alarmDao.unacknowledge(alarmId, user);\n            });\n    }\n\n    doAck(alarmId, user) {\n        return this.getAlarmDao()\n            .then(function(alarmDao) {\n                return alarmDao.acknowledge(alarmId, user);\n            });\n    }\n\n    doTicketAction(alarmId, action) {\n        var supportedActions = [\"create\", \"update\", \"close\"];\n        if (supportedActions.indexOf(action) < 0) {\n            throw {message: \"Action '\" + action + \"' not supported.\"};\n        }\n        var self = this;\n        return this.backendSrv.datasourceRequest({\n            url: self.url + '/api/v2/alarms/' + alarmId + \"/ticket/\" + action,\n            method: 'POST',\n        });\n    }\n\n    saveSticky(alarmId, sticky, user) {\n      return this.getAlarmDao()\n        .then(function(alarmDao) {\n          return alarmDao.saveStickyMemo(alarmId, sticky, user);\n        });\n    }\n\n    deleteSticky(alarmId) {\n      return this.getAlarmDao()\n        .then(function(alarmDao) {\n          return alarmDao.deleteStickyMemo(alarmId);\n        });\n    }\n\n    saveJournal(alarmId, journal, user) {\n      return this.getAlarmDao()\n        .then(function(alarmDao) {\n          return alarmDao.saveJournalMemo(alarmId, journal, user);\n        });\n    }\n\n    deleteJournal(alarmId) {\n      return this.getAlarmDao()\n        .then(function(alarmDao) {\n          return alarmDao.deleteJournalMemo(alarmId);\n        });\n    }\n\n    findNodes(options) {\n        var self = this;\n        return this.backendSrv.datasourceRequest({\n                url: self.url + '/rest/nodes',\n                method: 'GET',\n                params: {\n                    limit: options.limit || self.searchLimit,\n                }\n            }).then(function (results) {\n                    return {\n                        'count': results.data.count,\n                        'totalCount': results.data.totalCount,\n                        'rows': results.data.node\n                    };\n                });\n    }\n\n    findUsers(options) {\n        var self = this;\n        return this.backendSrv.datasourceRequest({\n            url: self.url + '/rest/users',\n            method: 'GET',\n            params: {\n                limit: options.limit || self.searchLimit, // TODO MVR this is not implemented on the user rest service\n            }\n        }).then(function (results) {\n            return {\n                'count': results.data.count,\n                'totalCount': results.data.totalCount,\n                'rows': results.data.user\n            };\n        });\n    }\n\n    findLocations(query) {\n        var self = this;\n        return this.backendSrv.datasourceRequest({\n            url: self.url + '/api/v2/monitoringLocations',\n            method: 'GET',\n            params: {\n                limit: query.limit || self.searchLimit,\n            }\n        }).then(function (results) {\n            return {\n                'count': results.data.count,\n                'totalCount': results.data.totalCount,\n                'rows': results.data.location\n            };\n        });\n    }\n\n    findCategories(options) {\n        var self = this;\n        return this.backendSrv.datasourceRequest({\n            url: self.url + '/rest/categories',\n            method: 'GET',\n            params: {\n                limit: options.limit || self.searchLimit, // TODO MVR this is not implemented on the rest service\n            }\n        }).then(function (results) {\n            return {\n                'count': results.data.count,\n                'totalCount': results.data.totalCount,\n                'rows': results.data.category\n            };\n        });\n    }\n\n    findSeverities(options) {\n        var severities = _.map(Model.Severities, function(severity) {\n            return {\n                id: severity.id,\n                label: severity.label\n            };\n        });\n        return this.$q.when(severities);\n    }\n\n    findServices(options) {\n        var self = this;\n        return this.backendSrv.datasourceRequest({\n            url: self.url + '/rest/foreignSourcesConfig/services/default',\n            method: 'GET',\n            params : {\n                limit: options.limit || self.searchLimit\n            }\n        }).then(function (results) {\n            return {\n                'count': results.data.count,\n                'totalCount': results.data.totalCount,\n                'rows': results.data.element\n            };\n        });\n    }\n\n    findOperators() {\n        var operators = _.map(API.Operators, function(operator) {\n            return {\n                id: operator.id,\n                label: operator.label\n            }\n        });\n        return this.$q.when(operators);\n    }\n\n    getProperties() {\n        return this.getAlarmDao()\n            .then(alarmDao => {\n                return alarmDao.searchProperties();\n            });\n    }\n\n    // TODO MVR it would be nice to query the rest endpoint directly for the property, rather than queriing for all of the elements\n    findProperty(propertyId) {\n        return this.getProperties()\n            .then(properties => {\n                return _.find(properties, function(property) {\n                    return property.id === propertyId;\n                });\n            })\n    }\n\n    getPropertyComparators(propertyId) {\n        return this.findProperty(propertyId)\n            .then(property => {\n                if (property) {\n                    const comparators = property.type.getComparators();\n                    if (comparators && comparators.length > 0) {\n                        return comparators;\n                    }\n                }\n                console.log(\"No comparators found for property with id '\" + propertyId + \"'. Falling back to EQ.\");\n                // This may be the case when the user entered a property, which does not exist\n                // therefore fallback to EQ\n                return [ API.Comparators.EQ ];\n            });\n    }\n}"]}