{"version":3,"sources":["../../../../src/datasources/fault-ds/datasource.js"],"names":["FeaturedAttributes","OpenNMSFMDatasource","instanceSettings","$q","backendSrv","templateSrv","contextSrv","type","url","name","q","alarmClient","jsonData","useGrafanaUser","grafanaUserField","user","login","options","filter","targets","Filter","limit","enforceTimeRange","clonedFilter","buildQuery","self","findAlarms","then","getClientWithMetadata","data","toTable","alarms","client","server","metadata","cloneFilter","withAndRestriction","NestedRestriction","Restriction","Comparators","GE","LE","substitute","clauses","each","clause","restriction","value","range","from","to","replace","scopedVars","status","message","title","catch","e","when","query","find","strategy","featuredAttributes","map","sortBy","attribute","id","getProperties","getPropertyComparators","searchForValues","findOperators","findProperty","property","findUsers","rows","label","findNodes","node","findCategories","category","findLocations","location","findSeverities","severity","findServices","service","columnNames","columns","column","row","alarm","count","ackUser","ackTime","uei","undefined","description","logMessage","reductionKey","troubleTicket","troubleTicketState","nodeId","nodeLabel","suppressedTime","suppressedUntil","suppressedBy","lastEvent","ipAddress","address","firstEventTime","time","source","createTime","sticky","body","author","updated","created","journal","meta","ticketerConfig","alarmId","getAlarm","doAck","doUnack","doClear","doEscalate","doTicketAction","saveSticky","deleteSticky","saveJournal","deleteJournal"],"mappings":"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","file":"datasource.js","sourcesContent":["import {ClientDelegate} from './client_delegate';\nimport {API} from '../../opennms';\nimport {FilterCloner} from \"./FilterCloner\"\nimport _ from 'lodash';\n\nconst FeaturedAttributes = [\n    \"alarmAckTime\", \"category\", \"ipAddress\",\n    \"location\", \"node.label\", \"reductionKey\",\n    \"service\", \"severity\", \"uei\"\n];\n\nexport class OpenNMSFMDatasource {\n\n  constructor(instanceSettings, $q, backendSrv, templateSrv, contextSrv) {\n    this.type = instanceSettings.type;\n    this.url = instanceSettings.url;\n    this.name = instanceSettings.name;\n    this.q = $q;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n    this.alarmClient = new ClientDelegate(instanceSettings, backendSrv, $q);\n\n    // When enabled in the datasource, the grafana user should be used instead of the datasource username on\n    // supported operations\n    if (instanceSettings.jsonData && instanceSettings.jsonData.useGrafanaUser) {\n        // If the datasource contains the field which should be used and that field is set, use it\n        if (instanceSettings.jsonData.grafanaUserField && contextSrv.user[instanceSettings.jsonData.grafanaUserField]) {\n            this.user = contextSrv.user[instanceSettings.jsonData.grafanaUserField];\n        } else { // otherwise the login is used instead\n            this.user = contextSrv.user.login;\n        }\n    }\n  }\n\n  query(options) {\n      // Initialize filter\n      var filter = options.targets[0].filter || new API.Filter();\n      filter.limit = 0; // no limit\n\n      options.enforceTimeRange = true;\n      const clonedFilter = this.buildQuery(filter, options);\n\n      var self = this;\n      return this.alarmClient.findAlarms(clonedFilter).then(alarms => {\n          return this.alarmClient.getClientWithMetadata().then(client => {\n              return {\n                data: self.toTable(alarms, client.server.metadata)\n              };\n          });\n      });\n  }\n\n  // Clone Filter to make substitution possible\n  // (otherwise substitution would happen in original query,\n  // and overwriting the $<variable> or [[variable]] in restrictions which may not be the intention)\n  buildQuery(filter, options) {\n      var clonedFilter = new FilterCloner().cloneFilter(filter);\n\n      // Before replacing any variables, add a global time range restriction (which is hidden to the user)\n      if (options && options.enforceTimeRange) {\n          clonedFilter.withAndRestriction(\n              new API.NestedRestriction()\n                  .withAndRestriction(new API.Restriction(\"lastEventTime\", API.Comparators.GE, \"$range_from\"))\n                  .withAndRestriction(new API.Restriction(\"lastEventTime\", API.Comparators.LE, \"$range_to\")));\n      }\n\n      // Substitute $<variable> or [[variable]] in the restriction value\n      this.substitute(clonedFilter.clauses, options);\n      return clonedFilter;\n  }\n\n  substitute(clauses, options) {\n      const self = this;\n      _.each(clauses, clause => {\n        if (clause.restriction) {\n            if (clause.restriction instanceof API.NestedRestriction) {\n                self.substitute(clause.restriction.clauses, options);\n            } else if (clause.restriction.value) {\n                // Range must be of type date, otherwise it is not parseable by the OpenNMS client\n                if (clause.restriction.value === '$range_from' || clause.restriction.value === \"[[range_from]]\") {\n                    clause.restriction.value = options.range.from;\n                } else if (clause.restriction.value === '$range_to' || clause.restriction.value === \"[[range_to]]\") {\n                    clause.restriction.value = options.range.to;\n                } else {\n                    clause.restriction.value = self.templateSrv.replace(clause.restriction.value, options.scopedVars);\n                }\n            }\n        }\n      });\n  }\n\n  testDatasource() {\n      return this.alarmClient.getClientWithMetadata()\n          .then(metadata => {\n              if (metadata) {\n                  return {\n                      status: \"success\",\n                      message: \"Data source is working\",\n                      title: \"Success\"\n                  };\n              }\n          }).catch(e => {\n              if (e.message === \"Unsupported Version\") {\n                  return {\n                      status: \"danger\",\n                      message: \"The OpenNMS version you are trying to connect to is not supported. \" +\n                               \"OpenNMS Horizon version >= 21.0.0 or OpenNMS Meridian version >= 2017.1.0 is required.\",\n                      title: e.message\n                  }\n              } else {\n                  throw e;\n              }\n          });\n  }\n\n  annotationQuery(options) {\n    return this.q.when([]);\n  }\n\n  metricFindQuery(query) {\n    if (!query || !query.find) {\n        return this.q.when([]);\n    }\n\n    if (query.find === \"attributes\") {\n        if (query.strategy === 'featured') {\n            const featuredAttributes = _.map(_.sortBy(FeaturedAttributes), (attribute) => {\n                return {id: attribute}\n            });\n            return this.q.when(featuredAttributes);\n        }\n        // assume all\n        return this.alarmClient.getProperties();\n    }\n    if (query.find === \"comparators\") {\n      return this.alarmClient.getPropertyComparators(query.attribute);\n    }\n    if (query.find == 'values') {\n        return this.searchForValues(query);\n    }\n    if (query.find === 'operators') {\n        return this.alarmClient.findOperators();\n    }\n    return this.q.when([]);\n  }\n\n  searchForValues(query) {\n      return this.alarmClient.findProperty(query.attribute)\n          .then(property => {\n              if (!property) {\n                  return this.q.when([]);\n              }\n              switch (property.id) {\n                  case 'alarmAckUser':\n                  case 'suppressedUser':\n                  case 'lastEvent.eventAckUser':\n                      return this.alarmClient.findUsers({query: query.query})\n                          .then(function (data) {\n                              return _.map(data.rows, function (user) {\n                                  return {\n                                      id: user['user-id'],\n                                      label: user['full-name']\n                                  };\n                              });\n                          });\n                  case 'node.label':\n                      return this.alarmClient.findNodes({query: query.query})\n                          .then(function (data) {\n                              return _.map(data.rows, function (node) {\n                                  return {\n                                      id: node.label,\n                                      label: node.label\n                                  }\n                              });\n                          });\n                  case 'category.name':\n                      return this.alarmClient.findCategories({query: query.query})\n                          .then(function (data) {\n                              return _.map(data.rows, function (category) {\n                                  return {\n                                      id: category.id,\n                                      label: category.name\n                                  };\n                              })\n                          });\n                  case 'location.locationName':\n                      return this.alarmClient.findLocations({query: query.query})\n                          .then(function (data) {\n                              return _.map(data.rows, function (location) {\n                                  return {\n                                      id: location['location-name'],\n                                      label: location['location-name']\n                                  };\n                              })\n                          });\n                  case 'severity':\n                      return this.alarmClient.findSeverities({query: query.query})\n                          .then(function (data) {\n                              return _.map(data, function (severity) {\n                                  return {\n                                      id: severity.id,\n                                      label: severity.label\n                                  }\n                              })\n                          });\n                  case 'serviceType.name':\n                      return this.alarmClient.findServices({query: query.query})\n                          .then(function (data) {\n                              return _.map(data.rows, function (service) {\n                                  return {\n                                      id: service,\n                                      label: service\n                                  }\n                              })\n                          });\n          }\n      });\n  }\n\n    // Converts the data fetched from the Alarm REST Endpoint of OpenNMS to the grafana table model\n    toTable(alarms, metadata) {\n        var columnNames = [\n            \"ID\", \"Count\", \"Acked By\", \"Ack Time\", \"UEI\", \"Severity\",\n            \"Type\", \"Description\", \"Log Message\", \"Reduction Key\",\n            \"Trouble Ticket\", \"Trouble Ticket State\", \"Node ID\", \"Node Label\", \"Service\",\n            \"Suppressed Time\", \"Suppressed Until\", \"Suppressed By\", \"IP Address\",\n            \"First Event Time\", \"Last Event ID\", \"Last Event Time\", \"Last Event Source\",\n            \"Last Event Creation Time\", \"Last Event Severity\",\n            \"Sticky ID\", \"Sticky Note\", \"Sticky Author\", \"Sticky Update Time\", \"Sticky Creation Time\",\n            \"Journal ID\", \"Journal Note\", \"Journal Author\", \"Journal Update Time\", \"Journal Creation Time\",\n            \"Data Source\"\n        ];\n\n        var columns = _.map(columnNames, column => {\n            return { \"text\" : column }\n        });\n\n        let self = this;\n        var rows = _.map(alarms, alarm => {\n            var row = [\n                alarm.id,\n                alarm.count,\n                alarm.ackUser,\n                alarm.ackTime,\n                alarm.uei,\n                alarm.severity.label,\n                alarm.type ? alarm.type.label : undefined,\n                alarm.description,\n\n                alarm.logMessage,\n                alarm.reductionKey,\n                alarm.troubleTicket,\n                alarm.troubleTicketState,\n                alarm.nodeId,\n                alarm.nodeLabel,\n                alarm.service ? alarm.service.name : undefined,\n                alarm.suppressedTime,\n                alarm.suppressedUntil,\n                alarm.suppressedBy,\n                alarm.lastEvent ? alarm.lastEvent.ipAddress ? alarm.lastEvent.ipAddress.address : undefined : undefined,\n\n                // Event\n                alarm.firstEventTime,\n                alarm.lastEvent ? alarm.lastEvent.id : undefined,\n                alarm.lastEvent ? alarm.lastEvent.time : undefined,\n                alarm.lastEvent ? alarm.lastEvent.source : undefined,\n                alarm.lastEvent ? alarm.lastEvent.createTime : undefined,\n                alarm.lastEvent ? alarm.lastEvent.severity.label : undefined,\n\n                // Sticky Note\n                alarm.sticky ? alarm.sticky.id : undefined,\n                alarm.sticky ? alarm.sticky.body : undefined,\n                alarm.sticky ? alarm.sticky.author : undefined,\n                alarm.sticky ? alarm.sticky.updated : undefined,\n                alarm.sticky ? alarm.sticky.created : undefined,\n\n                // Journal Note\n                alarm.journal ? alarm.journal.id : undefined,\n                alarm.journal ? alarm.journal.body : undefined,\n                alarm.journal ? alarm.journal.author : undefined,\n                alarm.journal ? alarm.journal.updated : undefined,\n                alarm.journal ? alarm.journal.created : undefined,\n\n                // Data Source\n                self.name\n            ];\n\n            row.meta = {\n                // Store the alarm for easy access by the panels - may not be necessary\n                'alarm': alarm,\n                // Store the name of the data-source as part of the data so that\n                // the panel can grab an instance of the DS to perform actions\n                // on the alarms\n                \"source\": this.name,\n                // Store the ticketerConfig here\n                \"ticketerConfig\": metadata.ticketerConfig\n            };\n            return row;\n        });\n\n        return [\n            {\n                \"columns\": columns,\n                \"rows\": rows,\n                \"type\": \"table\",\n            }\n        ];\n    }\n\n    getAlarm(alarmId) {\n        return this.alarmClient.getAlarm(alarmId);\n    }\n\n    acknowledgeAlarm(alarmId) {\n        return this.alarmClient.doAck(alarmId, this.user);\n    }\n\n    unacknowledgeAlarm(alarmId) {\n        return this.alarmClient.doUnack(alarmId, this.user);\n    }\n\n    clearAlarm(alarmId) {\n        return this.alarmClient.doClear(alarmId, this.user);\n    }\n\n    escalateAlarm(alarmId) {\n        return this.alarmClient.doEscalate(alarmId, this.user);\n    }\n\n    createTicketForAlarm(alarmId) {\n        return this.alarmClient.doTicketAction(alarmId, \"create\");\n    }\n\n    updateTicketForAlarm(alarmId) {\n        return this.alarmClient.doTicketAction(alarmId, \"update\");\n    }\n\n    closeTicketForAlarm(alarmId) {\n        return this.alarmClient.doTicketAction(alarmId, \"close\");\n    }\n\n    saveSticky(alarmId, sticky) {\n        return this.alarmClient.saveSticky(alarmId, sticky, this.user);\n    }\n\n    deleteSticky(alarmId) {\n        return this.alarmClient.deleteSticky(alarmId);\n    }\n\n    saveJournal(alarmId, journal) {\n        return this.alarmClient.saveJournal(alarmId, journal, this.user);\n    }\n\n    deleteJournal(alarmId) {\n        return this.alarmClient.deleteJournal(alarmId);\n    }\n}\n"]}