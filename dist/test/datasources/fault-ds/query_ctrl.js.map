{"version":3,"sources":["../../../../src/datasources/fault-ds/query_ctrl.js"],"names":["OpenNMSFMDatasourceQueryCtrl","$scope","$injector","$q","uiSegmentSrv","filterMapping","FilterMapping","target","filter","Filter","uiFilter","getUiFilter","rawQuery","panelCtrl","refresh","query","self","booleanList","map","clauses","clause","restriction","Query","showClearRestrictions","Controls","RemoveControl","reduce","overall","current","clear","updateControls","updateTargetFilter","getApiFilter","collapsedText","getQueryString","err","error","message","templateUrl"],"mappings":";;;;;;;;;AAAA;;AACA;;AACA;;;;AACA;;AACA;;AACA;;AACA;;;;;;;;;;IAEaA,4B,WAAAA,4B;;;AAEX,wCAAYC,MAAZ,EAAoBC,SAApB,EAA+BC,EAA/B,EAAkCC,YAAlC,EAAiD;AAAA;;AAAA,4JACzCH,MADyC,EACjCC,SADiC;;AAE/C,UAAKC,EAAL,GAAUA,EAAV;AACA,UAAKF,MAAL,GAAcA,MAAd;AACA,UAAKG,YAAL,GAAoBA,YAApB;AACA,UAAKC,aAAL,GAAqB,IAAI,iBAAQC,aAAZ,CAA0B,MAAKF,YAA/B,CAArB;;AAEA;AACA,UAAKG,MAAL,CAAYC,MAAZ,GAAqB,MAAKD,MAAL,CAAYC,MAAZ,IAAsB,IAAI,aAAIC,MAAR,EAA3C;AACA,UAAKC,QAAL,GAAgB,MAAKL,aAAL,CAAmBM,WAAnB,CAA+B,MAAKJ,MAAL,CAAYC,MAA3C,CAAhB;AAT+C;AAUhD;;;;uCAEkB;AACjB,WAAKD,MAAL,CAAYK,QAAZ,GAAuB,CAAC,KAAKL,MAAL,CAAYK,QAApC;AACD;;;uCAEkB;AACjB,WAAKC,SAAL,CAAeC,OAAf,GADiB,CACS;AAC3B;;;4CAEoD;AAAA,UAA7BC,KAA6B,uEAArB,KAAKL,QAAL,CAAcK,KAAO;;AACjD,UAAMC,OAAO,IAAb;AACA,UAAMC,cAAc,iBAAEC,GAAF,CAAMH,MAAMI,OAAZ,EAAqB,kBAAU;AACjD,YAAIC,OAAOC,WAAP,YAA8B,OAAGC,KAArC,EAA4C;AAC1C,iBAAON,KAAKO,qBAAL,CAA2BH,OAAOC,WAAlC,CAAP;AACD;AACD,eAAO,IAAI,OAAGG,QAAH,CAAYC,aAAhB,GAAgCjB,MAAhC,CAAuCO,KAAvC,EAA8CK,MAA9C,CAAP;AACD,OALmB,CAApB;;AAOA,aAAO,iBAAEM,MAAF,CAAST,WAAT,EAAsB,UAACU,OAAD,EAAUC,OAAV,EAAsB;AACjD,eAAOD,WAAWC,OAAlB;AACD,OAFM,EAEJ,KAFI,CAAP;AAID;;;wCAEmB;AAClB,WAAKlB,QAAL,CAAcmB,KAAd;AACA,WAAKnB,QAAL,CAAcoB,cAAd;AACA,WAAKC,kBAAL;AACD;;;yCAEkB;AACjB,WAAKxB,MAAL,CAAYC,MAAZ,GAAqB,KAAKH,aAAL,CAAmB2B,YAAnB,CAAgC,KAAKtB,QAArC,CAArB;AACA,WAAKG,SAAL,CAAeC,OAAf;AACH;;;uCAEoB;AACjB,UAAImB,gBAAgB,KAAKvB,QAAL,CAAcwB,cAAd,EAApB;AACA,aAAOD,aAAP;AACD;;;qCAEcE,G,EAAK;AAClB,WAAKC,KAAL,GAAaD,IAAIE,OAAJ,IAAe,8BAA5B;AACA,aAAO,EAAP;AACH;;;;;;AAGHrC,6BAA6BsC,WAA7B,GAA2C,iDAA3C","file":"query_ctrl.js","sourcesContent":["import {QueryCtrl} from 'app/plugins/sdk';\nimport './css/query-editor.css!'\nimport _ from 'lodash';\nimport {API} from '../../opennms';\nimport {Mapping} from './Mapping';\nimport {UI} from './UI';\nimport './query-directive'\n\nexport class OpenNMSFMDatasourceQueryCtrl extends QueryCtrl {\n\n  constructor($scope, $injector, $q,uiSegmentSrv)  {\n    super($scope, $injector);\n    this.$q = $q;\n    this.$scope = $scope;\n    this.uiSegmentSrv = uiSegmentSrv;\n    this.filterMapping = new Mapping.FilterMapping(this.uiSegmentSrv);\n\n    // define and set up model\n    this.target.filter = this.target.filter || new API.Filter();\n    this.uiFilter = this.filterMapping.getUiFilter(this.target.filter);\n  }\n\n  toggleEditorMode() {\n    this.target.rawQuery = !this.target.rawQuery;\n  }\n\n  onChangeInternal() {\n    this.panelCtrl.refresh(); // Asks the panel to refresh data.\n  }\n\n    showClearRestrictions(query = this.uiFilter.query) {\n      const self = this;\n      const booleanList = _.map(query.clauses, clause => {\n        if (clause.restriction instanceof UI.Query) {\n          return self.showClearRestrictions(clause.restriction);\n        }\n        return new UI.Controls.RemoveControl().filter(query, clause);\n      });\n\n      return _.reduce(booleanList, (overall, current) => {\n        return overall || current;\n      }, false);\n\n    }\n\n    clearRestrictions() {\n      this.uiFilter.clear();\n      this.uiFilter.updateControls();\n      this.updateTargetFilter();\n    }\n\n  updateTargetFilter() {\n      this.target.filter = this.filterMapping.getApiFilter(this.uiFilter);\n      this.panelCtrl.refresh();\n  }\n\n    getCollapsedText() {\n      var collapsedText = this.uiFilter.getQueryString();\n      return collapsedText;\n    }\n\n  handleQueryError(err) {\n      this.error = err.message || 'Failed to issue metric query';\n      return [];\n  }\n}\n\nOpenNMSFMDatasourceQueryCtrl.templateUrl = 'datasources/fault-ds/partials/query.editor.html';\n\n"]}